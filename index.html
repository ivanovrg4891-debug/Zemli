<script>
// ---------- Character ----------
let character = {
  hp:35,
  level:10,
  exp:0,
  baseStats:{ strength:30, agility:30, endurance:30, luck:20, mastery:20 },
  stats:{},
  equipment:{ weapon:null, body:null, legs:null },
  inventory:[
    { name:"–°—Ç–∞—Ä–∏–π –Ω—ñ–∂", img:"images/niz0.png", type:"weapon", slot:"weapon", stats:{ damage:3, strength:1 } },
    { name:"–ü–æ—Ç–µ—Ä—Ç–∞ –∫—É—Ä—Ç–∫–∞", img:"images/Bod0.png", type:"armor", slot:"body", stats:{ armor:1, hp:5 } },
    { name:"–î–∏—Ä—è–≤—ñ —à—Ç–∞–Ω–∏", img:"images/leg0.png", type:"armor", slot:"legs", stats:{ armor:1, agility:1, hp:2 } }
  ]
};

// ---------- Locations ----------
let locations = [
  {name:"–î–∏–∫–µ –£–∑–±–µ—Ä–µ–∂–∂—è", img:"images/loc.png", text:"–í—ñ—Ç–µ—Ä –∑ –º–æ—Ä—è‚Ä¶", mobs:[
    {name:"–î–∏–∫–∏–π –©—É—Ä", hp:18, str:2, agi:3, armor:1, exp:5, drops:[{name:"–•—É—Ç—Ä–æ", img:"https://i.imgur.com/1SgX3sJ.png", chance:0.6}], img:"https://i.imgur.com/1SgX3sJ.png"},
    {name:"–ë–µ—Ä–µ–≥–æ–≤–∏–π –ö–∞–±–∞–Ω", hp:30, str:4, agi:2, armor:1, exp:9, drops:[{name:"–ú º—è—Å–æ", img:"image/vepr0.png", chance:0.5}], img:"https://i.imgur.com/Q7cR6s2.png"}
  ]},
  {name:"–†—É—ó–Ω–∏ –°—Ç–∞—Ä–æ–¥–∞–≤–Ω—å–æ–≥–æ –§–æ—Ä—Ç–∞", img:"https://i.imgur.com/3Lz2p1Q.png", text:"–†—É—ó–Ω–∏ —Å—Ç–∞—Ä–æ–¥–∞–≤–Ω—å–æ–≥–æ —Ñ–æ—Ä—Ç—É‚Ä¶", mobs:[
    {name:"–¢—ñ–Ω—å –†—É—ó–Ω", hp:22, str:5, agi:4, armor:2, exp:20, drops:[{name:"–£–ª–∞–º–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É", img:"https://i.imgur.com/2RZmL5v.png", chance:0.15}], img:"https://i.imgur.com/2RZmL5v.png"},
    {name:"–°–∫–µ–ª–µ—Ç-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å", hp:30, str:6, agi:3, armor:3, exp:25, drops:[{name:"–ö—ñ—Å—Ç–∫–∞", img:"https://i.imgur.com/5tXeGjB.png", chance:0.6}], img:"https://i.imgur.com/1aKzS6n.png"}
  ]}
];

let currentLocation = locations[0];
let currentMob = null;
let battleLog = document.getElementById('battle-log');

// ---------- Save / Load ----------
function saveGame(){
  const saveData = { character, currentLocationIndex: locations.indexOf(currentLocation) };
  localStorage.setItem("lonely_lands_save", JSON.stringify(saveData));
  addLog("üíæ –ì—Ä—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
}

function loadGame(){
  const data = localStorage.getItem("lonely_lands_save");
  if(!data) return false;
  const save = JSON.parse(data);
  character = save.character;
  changeLocation(save.currentLocationIndex || 0);
  recalcStats();
  addLog("üìÇ –ì—Ä—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ");
  return true;
}

// ---------- Recalc Stats ----------
function recalcStats(){
  character.stats = {...character.baseStats};
  character.stats.hp = character.baseStats.endurance * 5 + 20;
  character.stats.armor = 0;
  character.stats.damage = 0;
  Object.values(character.equipment).forEach(item=>{
    if(!item || !item.stats) return;
    for(let stat in item.stats){
      character.stats[stat] = (character.stats[stat] || 0) + item.stats[stat];
    }
  });
  character.hp = Math.min(character.hp, character.stats.hp);
  document.getElementById('hp').innerText = character.hp;
  document.getElementById('strength').innerText = character.stats.strength;
  document.getElementById('agility').innerText = character.stats.agility;
  document.getElementById('endurance').innerText = character.stats.endurance;
  document.getElementById('luck').innerText = character.stats.luck;
  document.getElementById('mastery').innerText = character.stats.mastery;
}

// ---------- Combat ----------
function chooseMob(){
  if(!currentMob || currentMob.hp<=0){
    let availableMobs = currentLocation.mobs;
    currentMob = {...availableMobs[Math.floor(Math.random()*availableMobs.length)]};
    addLog(`–¢–∏ –∑—É—Å—Ç—Ä—ñ–≤ ${currentMob.name}! (HP: ${currentMob.hp})`);
    document.getElementById('location-img').style.backgroundImage = `url('${currentMob.img}')`;
  }
}

function attackMob(){
  chooseMob();
  if(!currentMob) return;
  let hitChance = 0.75 + character.stats.mastery*0.02;
  if(Math.random()>hitChance) addLog("–¢–∏ –ø—Ä–æ–º–∞—Ö–Ω—É–≤—Å—è!");
  else{
    let damage = Math.max(1, Math.floor(character.stats.strength*(0.8+Math.random()*0.4) - (currentMob.armor || 0)));
    currentMob.hp -= damage;
    addLog(`–¢–∏ –∑–∞–≤–¥–∞—î—à ${damage} —à–∫–æ–¥–∏ ${currentMob.name}! (HP –º–æ–±–∞: ${currentMob.hp})`);
  }
  if(currentMob.hp>0){
    let mobDamage = Math.max(1, Math.floor((currentMob.str || 1)*(0.8+Math.random()*0.4)));
    character.hp -= mobDamage;
    document.getElementById('hp').innerText = character.hp;
    addLog(`${currentMob.name} –∞—Ç–∞–∫—É—î —Ç–µ–±–µ ‚Äî ${mobDamage} —à–∫–æ–¥–∏!`);
  } else {
    addLog(`${currentMob.name} –ø–µ—Ä–µ–º–æ–∂–µ–Ω–∏–π!`);
    gainExp(currentMob.exp);
    dropItems(currentMob.drops);
    currentMob = null;
    document.getElementById('location-img').style.backgroundImage = `url('${currentLocation.img}')`;
  }
  if(character.hp<=0){
    addLog("–¢–∏ –Ω–µ–ø—Ä–∏—Ç–æ–º–Ω—ñ—î—à —ñ –ø—Ä–∏—Ö–æ–¥–∏—à –¥–æ —Ç—è–º–∏...");
    character.hp = Math.max(20, character.stats.endurance*5);
    document.getElementById('hp').innerText = character.hp;
  }
}

function gainExp(exp){
  character.exp += exp;
  addLog(`–¢–∏ –æ—Ç—Ä–∏–º–∞–≤ ${exp} EXP!`);
}

// ---------- Drop Items ----------
function dropItems(drops){
  drops.forEach(item=>{
    if(Math.random() < item.chance*(1 + character.stats.luck*0.02)){
      character.inventory.push(item);
      addLog(`–¢–∏ –æ—Ç—Ä–∏–º–∞–≤ –¥—Ä–æ–ø: ${item.name}`);
    }
  });
}

// ---------- Inventory ----------
function openInventory(){
  let modal = document.getElementById('inventory-modal');
  let container = document.getElementById('inventory-items');
  container.innerHTML = '';
  character.inventory.forEach((it,i)=>{
    let div = document.createElement('div');
    div.className='item';
    let statsText='';
    if(it.stats){
      for(let key in it.stats){ statsText += `<div style="font-size:12px;color:#ccc;">${key}: +${it.stats[key]}</div>`; }
    }
    // –ö–Ω–æ–ø–∫–∞ –æ–¥—è–≥—Ç–∏/–∑–Ω—è—Ç–∏
    let actionBtn='';
    if(it.slot && character.equipment[it.slot]===it){
      actionBtn=`<button onclick="unequip(${i})">–ó–Ω—è—Ç–∏</button>`;
    } else if(it.slot){
      actionBtn=`<button onclick="equip(${i})">–û–¥—è–≥—Ç–∏</button>`;
    }
    div.innerHTML = `<img src="${it.img}" alt="${it.name}"><div><strong>${it.name}</strong>${statsText}${actionBtn}</div>`;
    container.appendChild(div);
  });
  modal.style.display='block';
}

function closeInventory(){ document.getElementById('inventory-modal').style.display='none'; }

function equip(index){
  let item = character.inventory[index];
  if(item.slot){
    character.equipment[item.slot]=item;
    recalcStats();
    openInventory();
    addLog(`üü¢ –û–¥—è–≥–Ω—É—Ç–æ: ${item.name}`);
  }
}

function unequip(index){
  let item = character.inventory[index];
  if(item.slot && character.equipment[item.slot]===item){
    character.equipment[item.slot]=null;
    recalcStats();
    openInventory();
    addLog(`üî¥ –ó–Ω—è—Ç–æ: ${item.name}`);
  }
}

// ---------- Other ----------
function addLog(text){ battleLog.innerHTML += text+'<br>'; battleLog.scrollTop=battleLog.scrollHeight; }
function explore(){ addLog("–¢–∏ –¥–æ—Å–ª—ñ–¥–∂—É—î—à —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é‚Ä¶"); }
function showCharacter(){ addLog(`–ü–µ—Ä—Å–æ–Ω–∞–∂: –ì–µ—Ä–æ–π, —Ä—ñ–≤–µ–Ω—å ${character.level}, HP: ${character.hp}`); }

// ---------- Location ----------
function openLocationModal(){
  let modal=document.getElementById('location-modal');
  let list=document.getElementById('location-list');
  list.innerHTML='';
  locations.forEach((loc,i)=>{
    let btn=document.createElement('button');
    btn.innerText=loc.name; btn.onclick=()=>{changeLocation(i); closeLocationModal();};
    list.appendChild(btn);
  });
  modal.style.display='block';
}
function closeLocationModal(){ document.getElementById('location-modal').style.display='none'; }
function changeLocation(index){
  currentLocation=locations[index]; currentMob=null;
  document.getElementById('location-name').innerText=currentLocation.name;
  document.getElementById('location-text').innerText=currentLocation.text;
  document.getElementById('location-img').style.backgroundImage=`url('${currentLocation.img}')`;
  addLog(`–¢–∏ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏–≤—Å—è –¥–æ: ${currentLocation.name}`);
}
function changeLocationUI(){ openLocationModal(); }

// ---------- Init ----------
if(!loadGame()){ changeLocation(0); }
recalcStats();
</script>
